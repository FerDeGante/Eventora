# T-0012 — Guardrails RBAC en UI + rutas protegidas

Title: Guardrails RBAC en UI + rutas protegidas
Priority: A
Area: Security / Frontend
Owner Role: Planner / Implementer / Reviewer / QA

Problem (Evidence):
- La navegación muestra todas las secciones sin validar rol (navItems hardcodeados para cualquier usuario en `/apps/web/src/app/components/shell/AppChrome.tsx`).
- El contexto de auth guarda `role` pero no se usa para control de acceso UI (`/apps/web/src/app/hooks/useAuth.tsx`).
- El middleware solo valida presencia de token, no rol/tenant por ruta (`/apps/web/middleware.ts`).

Goal:
- Bloquear por rol el acceso a rutas y UI sensibles (admin/finanzas/settings), con feedback claro y redirección segura.

Scope (In/Out):
- In: mapa de permisos por rol, guard en rutas App Router, gating en navegación/CTAs, pantalla 403/“sin acceso”.
- Out: cambios de RBAC backend o JWT claims (solo consumo en frontend).

Implementation Plan (≤15 bullets):
1. Definir matriz de permisos por rol (routes + features).
2. Implementar guard en layout/app router para rutas protegidas por rol.
3. Añadir middleware/client guard para deep links (redirect + toast/403).
4. Ajustar `AppChrome` para ocultar/disable items según rol.
5. Añadir estado “sin acceso” con CTA (volver a dashboard).
6. Validar que `useAuth` expone rol/clínica de forma consistente.
7. Documentar roles permitidos por ruta en README/ROADMAP si aplica.

Files touched (expected):
- apps/web/src/app/components/shell/AppChrome.tsx
- apps/web/src/app/hooks/useAuth.tsx
- apps/web/middleware.ts
- apps/web/src/app/(app)/layout.tsx (o guard compartido)
- apps/web/src/app/components/AccessDenied.tsx (nuevo)

Acceptance Criteria (Given/When/Then):
1. Given un usuario RECEPTION, When navega a `/settings`, Then se muestra estado “sin acceso” y no se renderiza contenido sensible.
2. Given un usuario CLIENT, When visita `/reports` por URL directa, Then es redirigido a `/dashboard` con mensaje.
3. Given un usuario ADMIN, When abre cualquier ruta protegida, Then el acceso funciona sin fricción.
4. Given cualquier rol, When se renderiza el sidebar, Then solo ve las secciones permitidas.

KPI Impact:
- quality-only (seguridad, cumplimiento multi-tenant/RBAC).

Risks & Dependencies:
- Dependencia de que el token incluya `role` y `clinicId` actualizados.
- Requiere acordar matriz de permisos con backend/ops.

Test Evidence Required:
- `npm run lint`
- `npm run typecheck`
- Manual: login con ADMIN/RECEPTION/CLIENT y validar rutas/navegación.

Security & Tenant/RBAC Checks:
- [ ] Validación de rol por ruta
- [ ] Guard para deep links
- [ ] No exponer datos en UI al usuario sin rol
- [ ] Consistencia con roles definidos en AI.md

UX Checks:
- [ ] Mensaje “sin acceso” claro
- [ ] CTA de retorno
- [ ] Focus visible en estado 403
