# T-0013 — Instrumentación KPI en Booking → Checkout → Check-in

Title: Instrumentación KPI en Booking → Checkout → Check-in
Priority: B
Area: Observability
Owner Role: Planner / Implementer / Reviewer / QA

Problem (Evidence):
- La telemetría UX solo está implementada en wizard/pos/notifications (`/apps/web/src/app/(app)/wizard/page.tsx`, `/apps/web/src/app/(app)/pos/page.tsx`, `/apps/web/src/app/(app)/notifications/page.tsx`).
- El flujo público de booking y checkout no emite eventos de UX/KPI (`/apps/web/src/app/book/[slug]/page.tsx`, `/apps/web/src/app/book/[slug]/checkout/page.tsx`).
- No hay eventos específicos para medir time-to-cash, ocupación y no-show desde UI.

Goal:
- Capturar eventos clave del funnel (view → selección → reserva → pago → check-in/no-show) para medir KPIs core.

Scope (In/Out):
- In: eventos UX con `useUxMetrics` + esquema mínimo (booking_started, slot_selected, checkout_started, payment_completed, checkin_completed, no_show_marked).
- Out: almacenamiento analítico backend; solo emitir eventos y payloads estandarizados.

Implementation Plan (≤15 bullets):
1. Definir payload mínimo por evento (bookingId, clinicId, serviceId, timestamps).
2. Instrumentar `book/[slug]` en selección de servicio/slot y submit.
3. Instrumentar `book/[slug]/checkout` en inicio de pago y confirmación/cancelación.
4. Instrumentar `calendar` en acciones de check-in/no-show.
5. Normalizar `scope` en `useUxMetrics` y documentar eventos.
6. Añadir guard para no enviar PII directa.

Files touched (expected):
- apps/web/src/app/book/[slug]/page.tsx
- apps/web/src/app/book/[slug]/checkout/page.tsx
- apps/web/src/app/(app)/calendar/page.tsx
- apps/web/src/app/hooks/useUxMetrics.ts (si se amplía)
- docs/DECISIONS.md (si se define nuevo schema)

Acceptance Criteria (Given/When/Then):
1. Given un usuario inicia booking, When selecciona un slot, Then se emite `slot_selected` con timestamp.
2. Given checkout, When se crea sesión de pago, Then se emite `checkout_started`.
3. Given pago confirmado, When la UI recibe éxito, Then se emite `payment_completed` con delta time-to-cash.
4. Given frontdesk marca check-in/no-show, When cambia el status, Then se emite `checkin_completed` o `no_show_marked`.

KPI Impact:
- time-to-cash, ocupación, no-show.

Risks & Dependencies:
- Dependencia de `NEXT_PUBLIC_OBSERVABILITY_URL` configurado.
- Necesita IDs en respuesta API para correlación.

Test Evidence Required:
- `npm run lint`
- `npm run typecheck`
- Manual: recorrer booking → checkout → confirmación y verificar logs/eventos.

Security & Tenant/RBAC Checks:
- [ ] No enviar PII (email/teléfono) en payload
- [ ] Incluir clinicId derivado de sesión

UX Checks:
- [ ] Eventos no bloquean UI
- [ ] Sin impacto perceptible en performance
